---
import { useFlyoIntegration, useConfig } from "@flyo/nitro-astro";

const integration = useFlyoIntegration();
const config = await useConfig(Astro);

// Get environment variables
// helper: build (import.meta.env) first, then runtime (process.env)
const env = import.meta.env; // Astro/Vite env access
const readEnv = (key, fallback = "") => {
  const fromBuild = env?.[key];
  if (fromBuild !== undefined && fromBuild !== "") {
    return String(fromBuild);
  }

  const fromRuntime = typeof process !== "undefined" && process.env ? process.env[key] : undefined;
  if (fromRuntime !== undefined && fromRuntime !== "") {
    return String(fromRuntime);
  }

  return fallback;
};

// Get environment variables
const mode = readEnv("MODE", "-");
const vercelDeploymentId = readEnv("VERCEL_DEPLOYMENT_ID", "-");

// prefer your own sha, otherwise Vercel's
const gitSha = readEnv("VERCEL_GIT_COMMIT_SHA", "-");

// prefer your own release/version, otherwise empty
const version = readEnv("VERSION", "");

// Get token and determine type
const token = integration.options.accessToken || '';
const tokenType = token.startsWith('p-') ? 'production' : (token.startsWith('d-') ? 'develop' : 'unknown');

// Get live edit / debug status
const debug = integration.options.liveEdit;

// Get API version from config.nitro
const apiVersion = config.nitro?.version?.toString() || '-';
const apiLastUpdate = config.nitro?.updated_at 
  ? new Date(config.nitro.updated_at * 1000).toLocaleString('de-CH', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  : '-';

const debugInfoParts = [
  `liveedit:${debug}`,
  `env:${mode}`,
  `version:${apiVersion}`,
  `versiondate:${apiLastUpdate}`,
  `tokentype:${tokenType}`,
  `did:${vercelDeploymentId}`,
  `csha:${vercelGitCommitSha}`
];

if (version) {
  debugInfoParts.push(`release:${version}`);
}

const debugInfo = debugInfoParts.join(' | ');

---

<Fragment set:html={`<!-- ${debugInfo} -->`} />
