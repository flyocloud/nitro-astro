---
import { useFlyoIntegration, useConfig } from "@flyo/nitro-astro";

const integration = useFlyoIntegration();
const config = await useConfig(Astro);

// Get environment variables
const mode = import.meta.env.MODE;
const vercelDeploymentId = import.meta.env.VERCEL_DEPLOYMENT_ID || '-';
const vercelGitCommitSha = import.meta.env.VERCEL_GIT_COMMIT_SHA || '-';
const version = import.meta.env.VERSION || '';

// Get token and determine type
const token = integration.options.accessToken || '';
const tokenType = token.startsWith('p-') ? 'production' : (token.startsWith('d-') ? 'develop' : 'unknown');

// Get live edit / debug status
const debug = integration.options.liveEdit;

// Get API version from config.nitro
const apiVersion = config.nitro?.version?.toString() || '-';
const apiLastUpdate = config.nitro?.updated_at 
  ? new Date(config.nitro.updated_at * 1000).toLocaleString('de-CH', { 
      day: '2-digit', 
      month: '2-digit', 
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    })
  : '-';

const debugInfoParts = [
  `liveedit:${debug}`,
  `env:${mode}`,
  `version:${apiVersion}`,
  `versiondate:${apiLastUpdate}`,
  `tokentype:${tokenType}`,
  `did:${vercelDeploymentId}`,
  `csha:${vercelGitCommitSha}`
];

if (version) {
  debugInfoParts.push(`release:${version}`);
}

const debugInfo = debugInfoParts.join(' | ');

---

<Fragment set:html={`<!-- ${debugInfo} -->`} />
